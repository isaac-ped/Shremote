type: map

computed_fields:
    - key: user
      format:
          type: str
    - key: label
      format:
          type: str
    - key: args
      format:
          type: defaultdict

fields:
    - key: log_dir
      format:
          type: str
      default: '~/shremote_logs/'

    - key: ssh
      format:
          type: map
          fields:
                - key: user
                  format:
                    type: str
                  default: "{0.user}"
                - key: key
                  format:
                    type: str
                  default: "~/.ssh/id_rsa"
                - key: port
                  format:
                    type: int
                  default: 22

    - key: init_cmds
      format: &CMD_FORMAT
          type: list
          format:
                type: map
                flags: [formattable]
                fields:
                    - key: cmd
                      format:
                          type: str
                      flags: [required]
                    - &RTN_CHECK
                      key: checked_rtn
                      aliases: [check_rtn]
                      format:
                          type: [int, null]
                      default: 0


    - key: post_cmds
      format: *CMD_FORMAT

    - key: hosts
      format:
          type: map
          format:
                type: map
                fields:
                    - key: addr
                      format:
                          type: str
                      flags: [required]
                    - key: ssh
                      format:
                          type: override
                          overrides: [ssh]
                    - key: log_dir
                      format:
                          type: override
                          overrides: [log_dir]

    - key: files
      format:
          type: map
          flags: [formattable]
          format:
                type: map
                fields:
                      - key: src
                        format:
                            type: str
                        flags: [required]
                      - key: dst
                        format:
                            type: str
                        flags: [required]
                      - key: host
                        format:
                            type: reference
                            referent: [hosts]
                        flags: [list_ok]
          computed_fields:
              - key: out_dir
                format:
                    type: str

    - key: programs
      format:
          type: map
          format:
                type: map
                fields:
                    - key: host
                      format:
                          type: reference
                          referent: [hosts]
                      flags: [list_ok]
                    - key: start
                      format:
                          type: str
                      flags: [required]
                    - key: stop
                      format:
                          type: str
                      default: null
                    - key: log
                      format:
                          type: map
                          fields:
                                - key: dir
                                  default: ''
                                  format:
                                      type: str
                                - key: out
                                  format:
                                      type: str
                                - key: err
                                  format:
                                      type: str
                    - key: duration_reduced_error
                      format:
                          type: bool
                      default: true
                    - key: duration_exceeded_error
                      format:
                          type: bool
                      default: false
                    - key: defaults
                      format:
                          type: map
                    - key: bg
                      format:
                          type: bool
                      default: false
                    - *RTN_CHECK

    - key: commands
      format:
          type: list
          format:
                type: map
                flags: [formattable]
                fields:
                      - key: program
                        format:
                            type: reference
                            referent: [programs]
                        flags: [required]
                      - key: host
                        format:
                            type: inherit
                            parent: [program, host]
                        flags: [required]
                      - key: begin
                        format:
                            type: float
                        flags: [required]
                      - key: min_duration
                        format:
                            type: [int, null]
                        default: null
                      - key: max_duration
                        format:
                            type: [int, null]
                        default: null
                computed_fields:
                    - key: i
                      format:
                          type: int
                    - key: log_dir
                      format:
                          type: str
