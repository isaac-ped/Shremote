type: map

computed_fields:
    - key: user
      format:
          type: str
    - key: label
      format:
          type: str
    - key: args
      format:
          type: defaultdict

fields:
    - key: log_dir
      format:
          type: str
      default: '~/shremote_logs/'

    - key: ssh
      format:
          type: map
          fields:
                - key: user
                  format:
                    type: str
                  default: "{0.user}"
                - key: key
                  format:
                    type: str
                  default: "~/.ssh/id_rsa"
                - key: port
                  format:
                    type: int
                  default: 22

    - key: init_cmds
      format: &CMD_FORMAT
          type: list
          format:
                type: map
                flags: [format_root]
                fields:
                    - key: cmd
                      format:
                          type: str
                          flags: [required]
                    - &RTN_CHECK
                      key: checked_rtn
                      aliases: [check_rtn]
                      format:
                          type: [int, null]
                      default: 0


    - key: post_cmds
      format: *CMD_FORMAT

    - key: hosts
      format:
          type: map
          format: &host_fmt
                type: map
                fields:
                    - key: name
                      format:
                          type: key
                      default: null
                    - key: addr
                      format:
                          type: str
                          flags: [required]
                    - key: ssh
                      format:
                          type: map
                          flags: [inherit]
                          parent: [.., .., .., ssh]
                    - key: log_dir
                      format:
                          type: map
                          flags: [inherit]
                          parent: [.., .., .., log_dir]

    - key: files
      format:
          type: map
          flags: [format_root]
          format:
                type: map
                fields:
                      - key: name
                        format:
                            type: key
                        default: null
                      - key: src
                        format:
                            type: str
                            flags: [required]
                      - key: dst
                        format:
                            type: str
                            flags: [required]
                      - key: hosts
                        format:
                            type: reference
                            referent: [hosts]
                            flags: [list_ok]
          computed_fields:
              - key: out_dir
                format:
                    type: str

    - key: programs
      format:
          type: map
          format:
                type: map
                fields:
                    - key: name
                      format:
                          type: key
                      default: null
                    - key: hosts
                      format:
                          type: reference
                          referent: [hosts]
                          flags: [list_ok]
                    - key: start
                      format:
                          type: str
                          flags: [required]
                    - key: stop
                      format:
                          type: str
                      default: null
                    - key: log
                      format:
                          type: map
                          fields:
                                - key: dir
                                  default: ''
                                  format:
                                      type: str
                                - key: out
                                  format:
                                      type: str
                                - key: err
                                  format:
                                      type: str
                    - key: duration_reduced_error
                      format:
                          type: bool
                      default: true
                    - key: duration_exceeded_error
                      format:
                          type: bool
                      default: false
                    - key: defaults
                      format:
                          type: map
                    - key: bg
                      format:
                          type: bool
                      default: false
                    - *RTN_CHECK

    - key: commands
      format:
          flags: [required]
          type: list
          format:
                type: map
                flags: [format_root, inherit]
                parent: [program, defaults]
                fields:
                      - key: program
                        format:
                            type: reference
                            referent: [programs]
                            flags: [required]
                      - key: hosts
                        format:
                            type: map
                            flags: [inherit]
                            parent: [.., program, hosts]
                      - key: begin
                        format:
                            type: float
                            flags: [required]
                      - key: min_duration
                        format:
                            type: [int, null]
                        default: null
                      - key: max_duration
                        format:
                            type: [int, null]
                        default: null
                computed_fields:
                    - key: host_idx
                      format:
                          type: int
                    - key: log_dir
                      format:
                          type: str
                    - key: host
                      format:
                          type: defaultdict

